---
author: AJ Fagan
date: 12 Sept, 2024
title: I hate coming up with titles, please don't make me do this
subtitle: But it's the analysis of RNA-Seq of OVCAR3 cells in the presence of atovaquone up to 48 hours
output: html_document
---

```{r chunk-setup, echo=F}
knitr::opts_chunk$set(echo=F, message=F, warning=F, cache=T)
n=10
alpha = 0.05
```

```{r library-loading, cache=F}
library(pathfindR)
library(org.Hs.eg.db)
library(dplyr)
library(tidyr)
library(ggplot2)
library(AnnotationDbi)
library(DESeq2)
library(allez)
library(pheatmap)
library(RColorBrewer)
library(pathfindR)
```

```{r utility-functions}
# Format plot title
wrapper <- function(x, ...)
{
  paste(strwrap(x, ...), collapse = "\n")
}

```


```{r data-loading, include=F}
df <- read.csv("../../expression.mat", sep = "\t", row.names=1)
df.coding <- df[rowSums(df) > 0, ]
df.gene <- df.coding
df.gene$gene <- rownames(df.gene)
cts <- df.gene %>%
  mutate(
    symbol = (
      AnnotationDbi::select(org.Hs.eg.db, columns = c("ENSEMBL", "SYMBOL"), keys = rownames(df.coding), keytype = "ENSEMBL") %>%
        group_by(ENSEMBL) %>%
        summarize(SYMBOL = SYMBOL[1]) %>%
        data.frame(row.names = "ENSEMBL")
    )[gene, "SYMBOL"]
  ) %>%
  filter(!is.na(symbol)) %>%
  group_by(symbol) %>%
  summarise_at(1:36, sum) %>%
  data.frame(row.names = 1) %>%
  round()
```


```{r deseq-run, include=F}
coldata <- data.frame(
  treatment = factor(c(30, 30, 30, 45, 45, 45, "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", 30,30,30,30,30,30,30,30,30,45,45,45,45,45,45,45,45,45), levels = c("D", 30, 45)),
  time = factor(c(48,48,48,48, 48,48,1,1,1,24,24,24,8,8,8,48,48,48,1,1,1,24,24,24,8,8,8,1,1,1,24,24,24,8,8,8), levels = c(1, 8, 24, 48)),
  batch = as.factor(c("d", "d", "d", "d", "d", "d", "b", "c", "a", "b", "c", "a", "b", "c", "a", "d", "d", "d", "b", "c", "a", "b", "c", "a", "b", "c", "a", "b", "c", "a", "b", "c", "a", "b", "c", "a"))
)
coldata$batchA <- coldata$batch == "a"
cts
dds <- DESeqDataSetFromMatrix(
  countData = cts, 
  colData = coldata,
  design = ~ treatment*time + batchA
)

dds <- DESeq(dds, reduced = ~time + batchA, test = "LRT")
```



# Data visualization

First, we plot a hierarchical clustering of the data according to the raw estimated number of counts.
The plot shows that batches a, b/c, and d have huge differences between them, which cause the batch effect to be much more prevalent than either the treatment or time effect.
In particular, batch a seems much further than the others, while batch d seems fairly close to b/c.
Batch d contains only samples after 48 hours, so differences between it and b/c are unsurprising.

```{r hierarchical-clustering, echo=FALSE, warning=FALSE, message=FALSE}
ntd <- normTransform(dds)
sampleDists <- dist(t(assay(ntd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(ntd$time, ntd$treatment, ntd$batch, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)
```


A PCA plot supports this notion. 
This one seems to suggest that the vast majority of variance in the data can be attributed to variation between batch a, and the others. 
After that, the next largest contributor to variance seems to be differentiating between groups b/c and d, and, finally, between b and c.

```{r pca-plot, echo=FALSE, warning=FALSE, message=FALSE}
plotPCA(ntd, intgroup = c("batch"), pcsToUse = 1:2)
```

```{r results-45uM-48hrs}
res <- as.data.frame(results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  1 # 45 and 48 hrs
)))
```

After normalizing, we model our data as 
\[
  \log_2y_{gitjk} = \mu_g + {\rm Treatment}_{gi} + {\rm Time}_{gt} + {\rm TreatmentTime}_{git} + {\rm BatchA}_{gj} + \varepsilon_{gitjk},
\]
a linear model with an interaction between time and treatment, which includes a batch effect for batch A to account for varying levels of gene $g$ in DMSO after 1 hour in the batch A group compared to the rest.
The null model is set as
\[
  \log_2y_{gitjk} = \mu_g + {\rm Time}_{gt} + {\rm BatchA}_{gj} + \varepsilon_{gitjk},
\]
which still contains the batch adjustment, but now asserts that there is no treatment effect on the log-counts.



For each gene, we conduct a LRT to compare the full model to the reduced, null model, and, from that obtain a $p$-value. 
Those $p$-values are then adjusted using the Benjamini-Hochberg correction, to obtain an estimated False Discovery Rate.
False Discovery Rate cutoff is set at `r alpha`, and a total of `r (res %>% summarize(sum(!is.na(padj) & (padj < alpha))))[1,1]` genes are found to have a treatment effect.

We also extract from that model the MLE of the $\log_2$-fold change between DMSO and IC75 Atovaquone, each at 48 hours, to model the effect size of the treatment.
The `r n` genes with the lowest FDR are reported here.

```{r display-results-45uM-48hrs}


resOrdered <- res[complete.cases(res),]
resOrdered  <- resOrdered[order(resOrdered$pvalue),]
resOrdered <- resOrdered[resOrdered$padj < alpha,]

res %>% 
  arrange(padj) %>%
  select(log2FoldChange, pvalue, padj) %>%
  head(n) %>%
  mutate_if(is.numeric, ~ as.character(signif(., 3))) %>%
  knitr::kable()
```

# Heatmaps of fold-change expression

```{r de-over-time}
# 75 v DMSO @ 48
de.time <- data.frame(
  fc45.D.48 = results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  1 # 45 and 48 hrs
))$log2FoldChange
)

# 30 v DMSO @ 48
de.time$fc30.D.48 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  1, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 45 v DMSO @ 24
de.time$fc45.D.24 <- results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  1, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 30 v DMSO @ 24
de.time$fc30.D.24 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  1, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 45 v DMSO @ 8
de.time$fc45.D.8 <- results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  1, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 30 v DMSO @ 8
de.time$fc30.D.8 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  1, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 45 v DMSO @ 1
de.time$fc45.D.1 <- results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 30 v DMSO @ 1
de.time$fc30.D.1 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

rownames(de.time) <- rownames(results(dds))
de.time <- de.time[complete.cases(de.time),]

gene_ord_all <- list(
  "p" = rownames(results(dds)[order(res$padj, decreasing = F),]),
  "up" = rownames(results(dds)[order(res$log2FoldChange, decreasing = T),]),
  "down" = rownames(results(dds)[order(res$log2FoldChange, decreasing = F),]),
  'any' = rownames(results(dds)[order(abs(res$log2FoldChange), decreasing = T),])
)
gene_ord <- sapply(gene_ord_all, function(x) {
  x <- x[!is.na(results(dds)[x,"padj"]) & (results(dds)[x,"padj"] < 0.05)]
}, USE.NAMES = T, simplify = F)
gene_ord[['p']] <- gene_ord_all[['p']]

de.time <- de.time[complete.cases(de.time),]


# Plot a heatmap of diff. ex
treatment.pairs <- c(
"45uM v DMSO",
"30uM v DMSO"
)
de.coldata <- data.frame(
  time = rep(c(48, 24, 8, 1), each = 2),
  treatment = rep(c("45uM v DMSO", "30uM v DMSO"), 4)
)
rownames(de.coldata) <- colnames(de.time)
de.coldata <- de.coldata %>%
  arrange(treatment, time) %>%
  select(treatment, time)
de.heatmap <- function(
  n,
  x = de.time,
  treatment_pairs = treatment.pairs,
  times = c(1, 8, 24, 48),
  col_data = de.coldata,
  title = function(n, order_by) {
    switch(order_by,
                  p = paste(
                    "Estimated log2-fold change over DMSO for each treatment group at each time for the",
                    n,
                    "genes with the smallest p-value."
                  ),
                  up = paste(
                    "Estimated log2-fold change over DMSO for each treatment group at each time for the",
                    n,
                    "genes with the greatest log fold-change with p<0.05."
                  ),
                  down = paste(
                    "Estimated log2-fold change over DMSO for each treatment group at each time for the",
                    n,
                    "genes with the least log fold-change with p<0.05."
                  ),
                  any = paste(
                    "Estimated log2-fold change over DMSO for each treatment group at each time for the",
                    n,
                    "genes with the greatest absolute log fold-change with p<0.05."
                  )
    )
  },
  title_wrapper = 45,
  order_by = c("p", "up", "down", "any"),
  ...
) {
  order_by <- match.arg(order_by)
  
  x <- x[gene_ord[[order_by]],]
  col_data <- col_data %>%
    filter(time %in% times) %>%
    mutate(time = as.factor(time)) %>%
    filter(treatment %in% treatment_pairs) %>%
    mutate(treatment = factor(treatment, ordered = T)) %>%
    #arrange(treatment) %>%
    dplyr::rename("Time (Hours)" = time) %>%
    dplyr::rename("Treatment" = treatment)
  if (length(times) <= 1) {
    col_data <- col_data %>% dplyr::select(-c("Time (Hours)"))
  }
  x <- x[,colnames(x) %in% rownames(col_data)]
  x <- x[,rownames(col_data)]
  p <- pheatmap(
    as.matrix(x[1:n,]),
    annotation_col = col_data,
    cluster_rows = F, cluster_cols = F, show_colnames = F,
    legend_labels = c( "Time (Hours)", expression(paste("Treatment (", mu, "M)"))),
    main = wrapper(title(n, order_by), title_wrapper),
    legend = T,#c(expression(paste("45", mu, "M v DMSO", sep = "")), expression(paste("30", mu, "M v DMSO", sep = ""))),
    #legend_breaks = list(c(1, 8, 24, 48), c(expression(paste("45", mu, "M v DMSO", sep = "")), expression(paste("30", mu, "M v DMSO", sep = "")))),
    silent = T,
    ...
  )
  p$gtable$grobs[[6]]$children[[6]]$label <- c(expression(paste("30 ", mu, "M", sep = "")), expression(paste("45 ", mu, "M", sep = "")))
  #p$gtable$grobs[[5]]$label[1] <- expression(paste("Treatment (", mu, "M)"))
  grid::grid.newpage()
  grid::grid.draw(p$gtable )
  p
}
```

> Changed the fontsizes
> Only 30 is displayed here. Both 30 and 50 can be found in `comparisons/lfc-heatmaps-*.png`.

```{r save-heatmaps, include=F, eval=T}
for (k in 30:50) {
  png(filename = paste("plot-comparisons/lfc-heatmaps/heatmap-", k, ".png", sep = ""))
  de.heatmap(k, fontsize_row=5 + 3*((50 - k) / 20))
  dev.off()
}
```

```{r plot-heatmap, include=T, eval=T}
p <- de.heatmap(30, fontsize_row=8)
```


# Bar plots of lfc

## Sorted by $p$

Only 10 genes are shown here. Comparisons can be found in `comparisons/lfc-barplots-by_p-*.png`.

```{r barplots-prep}
genes.ordered <- factor(rownames(de.time), ordered=T)
de.time2 <- de.time
de.time2$gene <- rownames(de.time2)
de.time2 <- de.time2 %>%
  pivot_longer(-c(gene)) %>%
  mutate(treatment = de.coldata[name, "treatment"]) %>%
  mutate(time = as.factor(de.coldata[name,"time"])) %>%
  dplyr::rename(log2FoldChange = value)

de.barplot <- function(
    n, 
    genes = factor(rownames(de.time)),
    x = de.time2, 
    title = function(n, order_by) {
      switch(order_by,
                  p = paste(
                    "Bar plot of estimated log2-fold change for the",
                    n,
                    "genes with the smallest p-value."
                  ),
                  up = paste(
                    "Bar plot of estimated log2-fold change for the",
                    n,
                    "genes with the greatest log fold-change with p<0.05."
                  ),
                  down = paste(
                    "Bar plot of estimated log2-fold change for the",
                    n,
                    "genes with the least log fold-change with p<0.05."
                  ),
                  any = paste(
                    "Bar plot of estimated log2-fold change for the",
                    n,
                    "genes with the greatest absolute log fold-change with p<0.05."
                  )
      )
    },
    order_by = c("p", "up", "down", "any")
) {
  x$treatment <- substr(x$treatment, 1, 2)
  order_by <- match.arg(order_by)
  #print(head(de.time2 %>% filter(gene %in% gene_ord[[order_by]][1:n])))
  #print(length(unique((de.time2 %>% filter(gene %in% gene_ord[[order_by]][1:n]))$gene)))
  
  #print(head(de.time2 %>% filter(gene %in% gene_ord[[order_by]][1:n]) %>% filter(gene %in% genes)))
  ggplot(
    x %>% filter(gene %in% gene_ord[[order_by]][gene_ord[[order_by]] %in% genes][1:n]),
    aes(
      y = gene,
      x = log2FoldChange,
      fill = time
    )
  ) +
    geom_col(position= position_dodge(width = 0.9)) +
    facet_wrap(~treatment, labeller = label_bquote(cols = .(treatment) ~ mu * M)) +
    xlab("log2-Fold Change") +
    ylab("Gene") +
    guides(fill = guide_legend(title = "Time (Hours)")) +
    ggtitle(wrapper(title(n, order_by), 69)) +
      ylim(gene_ord[[order_by]][gene_ord[[order_by]] %in% genes][n:1]) +
      theme_classic()
}
```

```{r barplots-by-p, message=F, warning=F, cache=F}
for (k in 10:30) {
  de.barplot(k)
  ggsave(filename = paste("plot-comparisons/lfc-barplots/by_p/barplot-", k, ".png", sep = ""))
}

de.barplot(10)
```


## Sorted by absolute-lfc

Only 10 genes are shown here. Comparisons can be found in `comparisons/lfc-barplots-by_lfc-*.png`.

```{r barplots-by-lfc, cache=F}
for (k in 10:30) {
  de.barplot(k, order = "any")
  ggsave(filename = paste("plot-comparisons/lfc-barplots/by_lfc/barplot-", k, ".png", sep = ""))
}

de.barplot(10, order = "any")
```



## Number DE vs time


The plot below shows the number of DE genes (when compared to DMSO at the same time) over time. 
Note that, since we aren't much interested in the 1 hour time point, we keep a Bonferroni adjustment multiplier of 6, and we simply avoid inference on the 1 hour time point. 

We see that the number of DE genes does seem to increase over time, with the higher dose of atovaquone having typically more DE genes than the lower.
However, after 24 hours in the 45 uM group, the rate of new DE genes drops off, gaining only 371 genes by 48 hours, while the 30 uM group gained 1671 new DE genes in the same time. 

This image can be found in `figures/DE-counts.png`.

```{r contrast-prep}
# 75 v DMSO @ 48
contrasts <- list(
  h48.45vsD = c(
    0, # Intercept
    0, # 30 vs D
    1, # 45 vs D
    0, # 8 hrs vs 1 hr
    0, # 24 hrs vs 1 hr
    0, # 48 hrs vs 1 hr
    0, # batch A
    0, # 30 and 8 hrs
    0, # 45 and 8 hrs
    0, # 30 and 24 hrs
    0, # 45 and 24 hrs
    0, # 30 and 48 hrs
    1 # 45 and 48 hrs
  )
)

# 30 v DMSO @ 48
contrasts$h48.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  1, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 45 v DMSO @ 24
contrasts$h24.45vsD = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  1, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 30 v DMSO @ 24
contrasts$h24.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  1, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 45 v DMSO @ 8
contrasts$h8.45vsD = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  1, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 30 v DMSO @ 8
contrasts$h8.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  1, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

contrasts_all <- contrasts
# 45 v DMSO @ 1
contrasts_all$h1.45vsD = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 30 v DMSO @ 1
contrasts_all$h1.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)
```

```{r de-vs-time, warning=F, message=F}
p <- lapply(contrasts_all, function(x) {
  results(dds, test = "Wald", contrast = x) %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene") %>%
    mutate(sig = as.numeric(!is.na(padj) & padj < alpha / 6))
}) %>%
  bind_rows(.id = "comparison") %>%
  dplyr::select(comparison, gene, sig) %>%
  mutate(time = substr(comparison, 2, 3)) %>%
  mutate(time = ifelse(
    substr(time, 3, 3) == '.', 
    substr(time, 2, 2),
    as.numeric(time)
  )) %>%
  mutate(treatment = paste(
    ifelse(
      substr(comparison, 3, 3) == '.', 
      substr(comparison, 4, 5), 
      substr(comparison, 5, 6)
    ),
    "uM", sep = " "
  )) %>%
  group_by(time, treatment) %>%
  summarize(genes = sum(sig)) %>%
  mutate(time = as.factor(time)) %>%
  #filter(sig == 1) %>%
  ggplot(aes(x = time, y = log2(1+genes), fill = treatment)) +
    geom_col(position = "dodge2") +
    xlab("Time (Hours)") +
    ylab(expression(log2(1 + count))) +
    theme_classic()

png(filename = "figures/DE-counts.png")
p
dev.off()


p
```

This upset plot helps further elucidate the intersection pattern of these genes. This plot can be found in `figures/DE-upset.png`.

```{r upset-de-genes}
to_plot <- 
  lapply(contrasts_all, function(x) {
  results(dds, test = "Wald", contrast = x) %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene") %>%
    mutate(sig = as.numeric(!is.na(padj) & padj < alpha / 6))
})%>%
  bind_rows(.id = "comparison") %>%
  dplyr::select(comparison, gene, sig) %>%
  filter(sig == 1) %>%
  mutate(time = substr(comparison, 2, 3)) %>%
  mutate(time = ifelse(
    substr(time, 3, 3) == '.', 
    substr(time, 2, 2),
    as.numeric(time)
  )) %>%
  mutate(treatment =
    paste(ifelse(
      substr(comparison, 3, 3) == '.', 
      substr(comparison, 4, 5), 
      substr(comparison, 5, 6)
    ), " μM",
    sep = ""
  )) %>%
  mutate(time = paste(time, " hours", sep = "")) %>%
  mutate(group = paste(treatment, " @ ", time, sep = "")) %>%
  group_by(gene) %>%
  summarize(group = list(group))

to_plot %>%
  ggplot(aes(x = group)) +
    geom_bar() + 
    ggupset::scale_x_upset() +
    theme_classic() +  
    theme(axis.title.y = element_text(margin = margin(40, 40, 5, 0))) +
    xlab("Set Intersection") + 
    ylab("Intersection Size")
```



## Comparison in pairwise comparisons

Below is a table that summarizes the number of genes that are DE in each group compared to DMSO at the same time. 

The main diagonal indicates how many are in that group. For example, the top-left entry indicates that after 48 hours in 45 uM atovaquone, 3204 genes were DE, while the bottom right says that after 8 hours in 30 uM, only 10 genes were DE. 

The off-diagonal entries indicate the size of overlap between the respective groups indicated by the row and column. 
For example, the bottom left corner (or, equivalently, the top-right corner) indicates that there are 9 genes that are DE both in the 48 hours in 45 uM atovaquone vs 48 hours in DMSO, and in the 8 hours in 30 uM atovaquone vs 8 hours in DMSO. 
Since 8 hours in 30 uM has 9 DE genes, this indicates that there is only 1 gene DE in 30 uM after 8 hours that is *NOT* DE in 45 uM after 48 hours. 

A full summary of these intersections can be found in `results/gene-pairwise-significance.csv`.



```{r annoying-matrix}
dd <- lapply(contrasts, function(x) {
  results(dds, test = "Wald", contrast = x) %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene") %>%
    mutate(sig = as.numeric(!is.na(padj) & padj < alpha / 6))
}) %>%
  bind_rows(.id = "comparison") %>%
  dplyr::select(comparison, gene, sig)
  #tidyr::pivot_wider(names_from = "gene", values_from = sig) %>%
  #data.frame(row.names = "comparison") %>%
  #as.matrix(dimnames = list(rownames(.), NULL)) %>%

compdata <- data.frame(
  time = factor(rep(c("48 Hours", "24 Hours", "8 Hours"), each = 2), levels = c("48 Hours", "24 Hours", "8 Hours")),
  d1 = factor(rep(c("45 uM", "30 uM"), 3), levels = c("45 uM", "30 uM")),
  d2 = rep(c("DMSO", "DMSO"), 3),
  row.names = unique(dd$comparison)
)

dd <- dd %>%
  {
    dd <- .
    ccs <- unique(dd$comparison)
    combs <- combn(ccs, 2, simplify = T)
    combs <- cbind(combs, rbind(combs[2,], combs[1,]), rbind(ccs, ccs))
    data.frame(
      c1 = combs[1,],
      c2 = combs[2,],
      n = apply(combs, 2, function(cc) {
        (dd %>%
          filter(comparison %in% cc) %>%
          group_by(gene) %>%
          summarize(b = sum(sig) == length(unique(cc))) %>%
          summarize(b = sum(b)))[1,1, 1]
      }),
      time1 = sapply(combs[1,], function(x) compdata[x, "time"]),
      time2 = sapply(combs[2,], function(x) compdata[x, "time"]),
      d11 = sapply(combs[1,], function(x) compdata[x, "d1"]),
      d12 = sapply(combs[1,], function(x) compdata[x, "d2"]),
      d21 = sapply(combs[2,], function(x) compdata[x, "d1"]),
      d22 = sapply(combs[2,], function(x) compdata[x, "d2"])
    )
  }

dd2 <- dd %>% 
  dplyr::select(-c(c1, c2)) %>%
  arrange(time2, d21, d22) %>%
  tidyr::pivot_wider(
    id_cols = c("time1", "d11"),
    names_from = c("time2", "d21"),
    values_from = n,
    values_fn = mean
  )# %>%
as.data.frame(dd2) %>%
  arrange(time1, d11) %>%
  dplyr::select(-c(time1)) %>%
  dplyr::rename("Treatment" = "d11") %>%
  #dplyr::rename("Treatment 2" = "d12") %>%
  knitr::kable(align = 'lrrrrrrr', format = "html") %>% 
  #kableExtra::collapse_rows(1, valign = "top", latex_hline = "major") %>%
  #kableExtra::kbl(booktabs = T) %>%
  kableExtra::pack_rows(group_label = "Time", index = table(forcats::fct_inorder(as.character(dd2$time1)), useNA = "no")) %>%
  #kableExtra::pack_rows(group_label = "Treatment 1", index = table(forcats::fct_inorder(as.character(dd2$d11)), useNA = "no")) %>%
  kableExtra::header_separate(sep = "_") %>%
  kableExtra::column_spec(column=1, border_right = T)
```


```{r writing-sig-genes-per-group}
dd <- lapply(contrasts, function(x) {
  results(dds, test = "Wald", contrast = x) %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene") %>%
    mutate(sig = as.numeric(!is.na(padj) & padj < alpha / 6))
}) %>%
  bind_rows(.id = "comparison") %>%
  dplyr::select(comparison, gene, sig)
  #tidyr::pivot_wider(names_from = "gene", values_from = sig) %>%
  #data.frame(row.names = "comparison") %>%
  #as.matrix(dimnames = list(rownames(.), NULL)) %>%


dd2 <- dd %>%
  {
    dd <- .
    ccs <- unique(dd$comparison)
    dd2 <- data.frame(
      expand.grid(ccs, ccs, c(0,1))
    )
    colnames(dd2) <-  c('c1', 'c2', 'diff')
    dd2 <- dd2 %>% filter((c1 != c2) | (diff == 0))
    dd2 %>% 
      mutate(
        diff = as.numeric(diff),
        time1 = sapply(c1, function(x) compdata[x, "time"]),
        time2 = sapply(c2, function(x) compdata[x, "time"]),
        d11 = sapply(c1, function(x) compdata[x, "d1"]),
        d12 = sapply(c1, function(x) compdata[x, "d2"]),
        d21 = sapply(c2, function(x) compdata[x, "d1"]),
        d22 = sapply(c2, function(x) compdata[x, "d2"])
      ) 
    dd2$genes <- apply(dd2, MARGIN=1, function(x) {
      if (x['c1'] == x['c2']) {
        (dd %>%
          filter(
            ((comparison == x[['c1']]) & (as.numeric(sig) == 1))
          ) %>%
          group_by(gene) %>%
          summarize(n = n()) %>%
          filter(n > 0) %>%
          summarize(g = paste(gene, collapse = ";")))$g
      } else if (x[["diff"]] == 0) {
      #print(x)
        (dd %>%
          filter(
            ((comparison == x[['c1']]) & (as.numeric(sig) == 1)) | (
               (comparison == x[['c2']]) & (as.numeric(sig) == 1)
            )
          ) %>%
          group_by(gene) %>%
          summarize(n = n()) %>%
          filter(n > 1) %>%
          summarize(g = paste(gene, collapse = ";")))$g
      } else { # c1 != c2, diff == 1
        (dd %>%
          filter(
            ((comparison == x[['c1']]) & (as.numeric(sig) == 1)) | (
              (comparison == x[['c2']]) & (as.numeric(sig) == 0)
            )
          ) %>%
            group_by(gene) %>%
            summarize(n = n()) %>%
            filter(n > 1) %>%
            summarize(g = paste(gene, collapse = ";")))$g
      }
    })
    dd2
  }


out <- dd2 %>%
  mutate(c2 = ifelse(c1 == c2, "", as.character(c2))) %>%
  #arrange(c1, c2, 1-diff) %>%
  mutate(c2 = apply(., 1, function(x) {
    if (x['diff'] == 1) {
      x['c2']
    } else {
      paste('-', x['c2'], sep = "")
    }
  })) %>%
  dplyr::select(c1, c2, genes) %>% 
  apply(., 1, function(x) {
    # ll <- list()
    # ll[[x[[2]]]] <- strsplit(x[[3]], ";")[[1]]
    # mylist[[x[[1]]]] <- ll
    strsplit(x[[3]], ";")
    #print(length(strsplit(x[['genes']], ";")[[1]]))
  }, simplify=F)

names(out) <- apply(dd2, 1, function(x) {
  if (x['c1'] == x['c2']) {
    as.character(x['c1'])
  } else if (x['diff'] == 1) {
    paste(x['c1'], "but not", x['c2'])
  } else {
    paste(x['c1'], "and", x['c2'])
  }
})


outdf <- data.frame(a = out[[1]])
colnames(outdf) <- names(out[1])
for (i in 2:length(out)) {
  x <- out[[i]][[1]]
  x <- c(x, replicate(nrow(outdf) - length(x), ""))
  outdf[,names(out)[i]] <- x
}
write.table(outdf, "results/gene-pairwise-significance.csv", sep = ",", row.names=F)
```



# Gene Set Analysis

## Allez - Binary

To try and make sense of the gene-level results from our model, we apply a gene set analysis.
First, we use the *Allez* model, which, for each gene set, checks if that set has an unusually high number of stat. sig. DE genes for a set of its size.

After a Bonferonni correction, 286 gene sets with a number of genes between 5 and 500 are found to be "overly active."
The `r n` such sets with the highest $z$-score are displayed here, and a complete list can be found in `results/allez-sigsets.csv`.

```{r allez-bin, message=F}
allez.dat <- as.numeric(!is.na(results(dds)$padj) & (results(dds)$padj < alpha))
names(allez.dat) <- rownames(dds)
allez.out <- allez(allez.dat, "org.Hs.eg", idtype = "SYMBOL")
write.table(
  allezTable(allez.out) %>%
  arrange(-abs(z.score)),
  "results/allez-sigsets.csv",
  sep = ",",
  row.names = T
)
#allezTable(allez.out) %>%
#  arrange(-abs(z.score)) %>%
#  head(10)
```


Allez makes no attempt to consider the overlap between these gene sets. 
It does, however, provide a waterfall plot that helps visualize the results.
The plot works by first taking the stat. sig. gene set that explains the greatest number of genes, placing it at the top, and plotting those genes along the x-axis.
Then, iteratively, it takes the next stat. sig. gene set that explains the greatest number of *yet unexplained* genes, and plots them similarly, while also marking overlap between it and previously included genes. 

> Note to Mayra: I have a "beta" updated version of this code that may make this more visually appealing. Let me know if that's of interest.

```{r allez-bin-plot}
allezPlot(allez.out)
```

## Allez - $-\log(p)$

Allez is also very flexible, and can use any score for each gene as input. 
If we want to prioritize more significant genes more strongly, for example, we could use $-\log(p)$ as the score.
Using this scoring method, the top `r n` gene sets are similarly reported, and all 462 stat. sig. gene sets are saved in `results/allez-logp-sigsets.csv`.

```{r allez-neg-logp, message=F}
allez.dat.cont <- -log(results(dds)$padj)
allez.dat.cont[is.na(allez.dat.cont)] <- 0
names(allez.dat.cont) <- rownames(dds)
allez.out.cont <- allez(allez.dat.cont, "org.Hs.eg", idtype = "SYMBOL")
write.table(
  allezTable(allez.out.cont) %>%
  arrange(-abs(z.score)),
  "results/allez-logp-sigsets.csv",
  sep = ",",
  row.names = T
)
#allezTable(allez.out.cont) %>%
#  arrange(-abs(z.score)) %>%
#  head(10)
```

And a corresponding Allez plot is also provided.

```{r allez-neg-logp-plot}
allezPlot(allez.out.cont)
```



## pathfindR

### With 15

We also include pathway analysis using the pathfindR model. 
This model looks for active subnetworks of a Protein Interaction Network (PIN), and then conducts Pathway Enrichment Analysis on KEGG pathways to find those that are enriched. 

This method found 247 enriched KEGG terms, of which, the 10 with the lowest $p$-value are displayed below. All such terms are contained in `results/pathfindR-active-sets.csv`.


```{r run-pathfindR, cache=T}
path.out <- run_pathfindR(
  res %>%
    mutate(gene = rownames(.)) %>%
    dplyr::select(gene, log2FoldChange, padj) %>%
    mutate(padj = ifelse(is.na(padj), 1, padj))
)
enrichment_chart(path.out, top_terms = 15)
```


```{r plot-pathfindR-kegg-diagrams, include=F, eval=F}
visualize_term_interactions(path.out[1,], "KEGG")
input_processed = input_processing(res %>%
    mutate(gene = rownames(.)) %>%
    dplyr::select(gene, log2FoldChange, padj) %>%
    mutate(padj = ifelse(is.na(padj), 1, padj)))
kegg_paths <- visualize_terms(path.out, input_processed)
for (i in 1:length(kegg_paths)) {
  if (i < 10) {
    r = paste("00", as.character(i),  sep = "")
  } else if (i < 100) {
    r = paste("0", as.character(i), sep = "")
  } else {
    r = as.character(i)
  }
  desc <- (path.out %>%
    filter(ID == names(kegg_paths)[i]))$Term_Description[1]
  ggsave(
    filename = paste("figures/pathfindR-vis/r", r, "-", desc, ".png", sep = ""),
    kegg_paths[[i]],
    device = "png"
  )
}
```

A hierarchical clustering of these terms shows 7 main clusters

1. Spliceosome 
2. Proteasome + Spinocerebellar ataxia
3. Ribosome
4. OxPhos + Parkinson + Diabetic Cardiomyopathy + Chemical carcin. ROS + Huntington + Prion + Thermogenesis + Non-alc. fatty liver dis.
5. Cell cycle
6. Protein Processing in ER
7. Ubiq. med. proteolysis

This indicates that the other 8 gene sets share a great deal of genes in common, which may help explaining why, e.g., Prion Disease shows up in a dataset where we would not particularly expect it to --- the KEGG pathway for Prion Disease may simply be quite similar to other pathways, such as that of OxPhos, which we would expect to show up. 

```{r rename-long-kegg15}
path.out$Term_Description[4] <- "OxPhos"
path.out$Term_Description[7] <- "Chemical carcin. - ROS"
path.out$Term_Description[11] <- "Non-alc. fatty liver dis."
path.out$Term_Description[13] <- "Protein proc. in ER"
path.out$Term_Description[15] <- "Ubiq. med. proteolysis"
```

First, the clustering as a dendrogram.

```{r pathfindR-dend15, message=F}
set.seed(42)
kappa_mat <- create_kappa_matrix(enrichment_res = path.out[1:15,], 
        use_description = T, use_active_snw_genes = F)
clu <- cluster_enriched_terms(path.out[1:15,], use_description = T, method="hierarchical", plot_clusters_graph=F)
clu_obj <- R.utils::doCall("hierarchical_term_clustering", 
            kappa_mat = kappa_mat, enrichment_res = path.out[1:15,], 
            use_description = T, plot_hmap=F, plot_dend=F)

```

Now as a heatmap.

```{r pathfindR-heatmap15}
stats::heatmap(kappa_mat, distfun = function(x) stats::as.dist(1 - 
            x), hclustfun = function(x) stats::hclust(x, method = "average"), margins = c(10,5))
```

And now as a this thing.

```{r pathfindR-graphvis15}
cluster_graph_vis(clu_obj, kappa_mat, path.out[1:15,], use_description = T, vertex.size.scaling = 1.0, vertex.label.cex = 0.7)
#clu <- cluster_enriched_terms(path.out[1:15,], use_description = F, method="hierarchical")
```



These plots show a plot of the genes of each cluster of terms, along with the direction of change. 
As you can see, the Spliceosome and Ribosome sets share few actual genes in common, indicating that the relation between the two is a bit more complex.
However, the other 8 terms share many genes in common.
In fact, Parkinson, Huntington, and Prion disease pathways all look like ROS + Proteasome + Others. 


```{r pathfindR-term-gene-heatmap15}
term_gene_heatmap(clu %>% arrange(Cluster), use_description = T, num_terms = 15) +
  xlab("Gene") +
  theme(axis.text.x = element_blank()) 
  

```

An upset can be used to see the size of various intersection patterns between these 10 gene sets. 

```{r pathfindR-upset15, warning=F}
lout = "circlepack"
p0 <- term_gene_graph(path.out[1:15,], use_description = T, num_terms=15)
g <- tidygraph::to_directed(attributes(p0$data)$graph)

ggVennDiagram::ggVennDiagram(setNames(list(
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[1])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[2])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[3])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[4])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[5])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[6])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[7])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[8])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[9])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[10])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[11])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[12])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[13])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[14])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[15]))
), igraph::vertex_attr(g, "name", igraph::V(g)[1:15])), nintersects = 30)
```


And we can also show the bubbleplot with divisions for these clusters.

```{r pathfindR-enrich-clu15}
enrichment_chart(clu, top_terms = 15, plot_by_cluster = T)
```

### With 20

```{r rename-long-kegg2}
path.out$Term_Description[4] <- "OxPhos"
path.out$Term_Description[7] <- "Chemical carcin. - ROS"
path.out$Term_Description[11] <- "Non-alc. fatty liver dis."
path.out$Term_Description[13] <- "Protein proc. in ER"
path.out$Term_Description[15] <- "Ubiq. med. proteolysis"
path.out$Term_Description[16] <- "COVID-19"
path.out$Term_Description[17] <- "Nucleocyt. trans."
path.out$Term_Description[18] <- "Retro. endocann. sig."
path.out$Term_Description[19] <- "TGF-beta sig."
path.out$Term_Description[20] <- "Viral carcin."
```

```{r pathfindR-enrich20}
enrichment_chart(path.out, top_terms = 20, plot_by_cluster = F)
```

A hierarchical clustering of these terms shows 8 main clusters

1. Spliceosome 
2. Proteasome + Spinocerebellar ataxia
3. Ribosome + COVID-19
4. OxPhos + Parkinson + Diabetic Cardiomyopathy + Chemical carcin. ROS + Huntington + Prion + Thermogenesis + Non-alc. fatty liver dis.
5. Cell cycle + TGF-beta sig. + Viral carcin.
6. Protein Processing in ER
7. Ubiq. med. proteolysis
8. Nucleocyoplasmic transport

This indicates that the other 8 gene sets share a great deal of genes in common, which may help explaining why, e.g., Prion Disease shows up in a dataset where we would not particularly expect it to --- the KEGG pathway for Prion Disease may simply be quite similar to other pathways, such as that of OxPhos, which we would expect to show up. 



```{r pathfindR-dend20, message=F}
set.seed(42)
kappa_mat <- create_kappa_matrix(enrichment_res = path.out[1:20,], 
        use_description = T, use_active_snw_genes = F)
clu <- cluster_enriched_terms(path.out[1:20,], use_description = T, method="hierarchical", plot_clusters_graph=F)
clu_obj <- R.utils::doCall("hierarchical_term_clustering", 
            kappa_mat = kappa_mat, enrichment_res = path.out[1:20,], 
            use_description = T, plot_hmap=F, plot_dend=F)

```

Now as a heatmap.

```{r pathfindR-heatmap20}
stats::heatmap(kappa_mat, distfun = function(x) stats::as.dist(1 - 
            x), hclustfun = function(x) stats::hclust(x, method = "average"), margins = c(10,5))
```

And now as a this thing.

```{r pathfindR-graphvis20}
cluster_graph_vis(clu_obj, kappa_mat, path.out[1:20,], use_description = T, vertex.size.scaling = 1.0, vertex.label.cex = 0.7)
#clu <- cluster_enriched_terms(path.out[1:15,], use_description = F, method="hierarchical")
```


These plots show a plot of the genes of each cluster of terms, along with the direction of change. 
As you can see, the Spliceosome and Ribosome sets share few actual genes in common, indicating that the relation between the two is a bit more complex.
However, the other 8 terms share many genes in common.
In fact, Parkinson, Huntington, and Prion disease pathways all look like ROS + Proteasome + Others. 


```{r pathfindR-term-gene-heatmap20}
term_gene_heatmap(clu %>% arrange(Cluster), use_description = T, num_terms = 20) +
  xlab("Gene") +
  theme(axis.text.x = element_blank()) 

```


```{r pathfindR-upset-20, warning=F}
lout = "circlepack"
p0 <- term_gene_graph(path.out[1:20,], use_description = T, num_terms=20)
g <- tidygraph::to_directed(attributes(p0$data)$graph)

ggVennDiagram::ggVennDiagram(setNames(list(
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[1])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[2])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[3])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[4])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[5])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[6])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[7])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[8])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[9])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[10])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[11])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[12])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[13])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[14])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[15])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[16])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[17])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[18])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[19])),
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[20]))
), igraph::vertex_attr(g, "name", igraph::V(g)[1:20])), nintersects = 20)
```


And we can also show the bubbleplot with divisions for these clusters.

```{r pathfindR-enrich-clu20}
enrichment_chart(clu, top_terms = 20, plot_by_cluster = T)
```


```{r generate-lfc-list, include=F, eval=F, echo=F}

lfc_list <- lapply(names(contrasts_all), function(x) {
  df <- results(dds, test="Wald", contrast = contrasts_all[[x]]) %>%
    as.data.frame() %>%
    select(log2FoldChange, padj) %>%
    mutate(contrast = x) %>%
    tibble::rownames_to_column("gene")
  df
}) %>%
  bind_rows() %>%
  arrange(gene, contrast) %>%
  mutate(time = substr(contrast, 2, 3)) %>%
  mutate(time = ifelse(
    substr(time, 3, 3) == '.', 
    substr(time, 2, 2),
    as.numeric(time)
  )) %>%
  mutate(treatment = paste(
    ifelse(
      substr(contrast, 3, 3) == '.', 
      substr(contrast, 4, 5), 
      substr(contrast, 5, 6)
    ),
    "μM", sep = " "
  )) %>%
  select(-contrast) %>%
  pivot_longer(c(log2FoldChange, padj)) %>%
  pivot_wider(id_cols = gene, names_from = c(time, treatment, name), values_from = value)
write.table(lfc_list, "results/lfc-list.csv", sep = ",", row.names = F)
head(lfc_list)
```



```{r pathfindR-enrich-cluN, eval=F, include=F, echo=F}
for (k in 20:50) {
  clu <- cluster_enriched_terms(path.out[1:k,], use_description = T, method="hierarchical", plot_clusters_graph=F, plot_dend=F)
  p <- enrichment_chart(clu, top_terms = k, plot_by_cluster = T)
  #png(filename = paste("/mnt/hdd/AJNewton/rnaseq-2023/analysis-with-48hrs/post-12sept-meeting/plot-comparisons/pathfindR-bubbleplot-clusters/bubbleplot-", k, ".png", sep = ""))
  #p
  #dev.off()
  ggsave(filename = paste("/mnt/hdd/AJNewton/rnaseq-2023/analysis-with-48hrs/post-12sept-meeting/plot-comparisons/pathfindR-bubbleplot-clusters/bubbleplot-", k, ".png", sep = ""), plot = p)
}
p <- enrichment_chart(cluster_enriched_terms(path.out[1:50,], use_description = T, method="hierarchical", plot_clusters_graph=F, plot_dend=F), top_terms = 50, plot_by_cluster = T)
p
?enrichment_chart
unique(clu$Cluster)
clu %>%
  group_by(Cluster) %>%
  summarize(n = n())
for (k in 20:50) {dev.off()}
```









