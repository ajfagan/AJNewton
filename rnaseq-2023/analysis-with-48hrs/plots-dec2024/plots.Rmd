---
title: "Plots for Mayra"
output:
  html_document:
    df_print: paged
---

## Blurb

Gene expression counts were obtained using RSEM with the STAR aligner.
The DESeq2 package was used for normalization and differential expression analysis, testing for the presence of a treatment effect on expression, while controlling for time and batch effects.
Pathway enrichment analysis was conducted with the PathfindR package.



```{r, include=F}
text_size = 20
knitr::opts_chunk$set(
  echo=F,
  cache=T,
  message=F,
  include=T,
  warning=F,
  fig.height = 10,
  fig.width = 10
)
```

```{r, warning=F, message=F, include=F, results='hide'}
alpha = 0.05
n = 10
library(DESeq2)
library(dplyr)
#library(rlang)
#library(purrr)
# library(tidyverse)
library(pheatmap)
#library(colourpicker)
library(bslib)
library(ggplot2)
library(colorspace)
library(pathfindR)
library(org.Hs.eg.db)
library(RColorBrewer)
```


```{r, include=F}
df <- read.csv("expression.mat", sep = "\t", row.names=1)
df.coding <- df[rowSums(df) > 0, ]
df.gene <- df.coding
df.gene$gene <- rownames(df.gene)
cts <- df.gene %>%
  mutate(
    symbol = (
      AnnotationDbi::select(org.Hs.eg.db, columns = c("ENSEMBL", "SYMBOL"), keys = rownames(df.coding), keytype = "ENSEMBL") %>%
        group_by(ENSEMBL) %>%
        summarize(SYMBOL = SYMBOL[1]) %>%
        data.frame(row.names = "ENSEMBL")
    )[gene, "SYMBOL"]
  ) %>%
  filter(!is.na(symbol)) %>%
  group_by(symbol) %>%
  summarise_at(1:36, sum) %>%
  data.frame(row.names = 1) %>%
  round()

head(cts) 
```

# DE Analysis

```{r include=F}
coldata <- data.frame(
  treatment = factor(c(30, 30, 30, 45, 45, 45, "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", 30,30,30,30,30,30,30,30,30,45,45,45,45,45,45,45,45,45), levels = c("D", 30, 45)),
  time = factor(c(48,48,48,48, 48,48,1,1,1,24,24,24,8,8,8,48,48,48,1,1,1,24,24,24,8,8,8,1,1,1,24,24,24,8,8,8), levels = c(1, 8, 24, 48)),
  batch = as.factor(c("d", "d", "d", "d", "d", "d", "b", "c", "a", "b", "c", "a", "b", "c", "a", "d", "d", "d", "b", "c", "a", "b", "c", "a", "b", "c", "a", "b", "c", "a", "b", "c", "a", "b", "c", "a"))
)
coldata$batchA <- coldata$batch == "a"

dds <- DESeqDataSetFromMatrix(
  countData = cts, 
  colData = coldata,
  design = ~ treatment*time + batchA
)

dds <- DESeq(dds, reduced = ~time + batchA, test = "LRT")
#dds <- DESeq(dds, reduced = ~treatment + batchA, test = "LRT")
```


# Data visualization

First, we plot a hierarchical clustering of the data according to the raw estimated number of counts.
The plot shows that batches a, b/c, and d have huge differences between them, which cause the batch effect to be much more prevalent than either the treatment or time effect.
In particular, batch a seems much further than the others, while batch d seems fairly close to b/c.
Batch d contains only samples after 48 hours, so differences between it and b/c are unsurprising.

```{r hierarchical-clustering, echo=FALSE, warning=FALSE, message=FALSE}
ntd <- normTransform(dds)
sampleDists <- dist(t(assay(ntd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(ntd$time, ntd$treatment, ntd$group, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)
```



A PCA plot supports this notion. 
This one seems to suggest that the vast majority of variance in the data can be attributed to variation between batch a, and the others. 
After that, the next largest contributor to variance seems to be differentiating between groups b/c and d, and, finally, between b and c.

```{r pca-plot, echo=FALSE, warning=FALSE, message=FALSE}
plotPCA(ntd, intgroup = c("batch"), pcsToUse = 1:2)
```





After normalizing, we model our data as 
\[
  \log_2y_{gitjk} = \mu_g + {\rm Treatment}_{gi} + {\rm Time}_{gt} + {\rm TreatmentTime}_{git} + {\rm BatchA}_{gj} + \varepsilon_{gitjk},
\]
a linear model with an interaction between time and treatment, which includes a batch effect for batch A to account for varying levels of gene $g$ in DMSO after 1 hour in the batch A group compared to the rest.
The null model is set as
\[
  \log_2y_{gitjk} = \mu_g + {\rm Time}_{gt} + {\rm BatchA}_{gj} + \varepsilon_{gitjk},
\]
which still contains the batch adjustment, but now asserts that there is no treatment effect on the log-counts.



For each gene, we conduct a LRT to compare the full model to the reduced, null model, and, from that obtain a $p$-value. 
Those $p$-values are then adjusted using the Benjamini-Hochberg correction, to obtain an estimated False Discovery Rate.
False Discovery Rate cutoff is set at 0.01.

We also extract from that model the MLE of the $\log_2$-fold change between DMSO and IC75 Atovaquone, each at 48 hours, to model the effect size of the treatment.
The genes with the lowest FDR are reported here.

```{r}
res <- as.data.frame(results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  1 # 45 and 48 hrs
)))

resOrdered <- res[complete.cases(res),]
resOrdered  <- resOrdered[order(resOrdered$pvalue),]
resOrdered <- resOrdered[resOrdered$padj < 0.01,]

res %>% 
  arrange(padj) %>%
  dplyr::select(log2FoldChange, pvalue, padj) %>%
  head(n) %>%
  mutate_if(is.numeric, ~ as.character(signif(., 3))) %>%
  knitr::kable()
```


To further investigate these genes, a heatmap showing the residuals under the null model that the values are dependent only on time is displayed.
Each row is a gene (marked on the left, along with the estimated FDR), and each column is a sample.
Higher residuals (more red) imply that the genes in that sample are more highly expressed than on average across samples. 

Looking at the one-hour columns, we see that there is often little variation between the three treatments.
However, DDIT3, in the presence of IC75 atovaquone, does seem to be elevated compared to DMSO after only one hour.

```{r residual-heatmap, echo=FALSE, warning=FALSE, message=FALSE}
null_df <- DESeqDataSetFromMatrix(
  countData = cts,
  colData = coldata,
  design = ~ time + batchA
)
null_df <- DESeq(null_df, reduced = ~ batchA, test = "LRT")

log2mu <- log2(1 + t(t(assays(null_df)[["mu"]]) / sizeFactors(null_df)))
resids <- log2(1 + counts(null_df, normalized = TRUE)) - log2mu

nselect <- 20
select <- rownames(resOrdered)[1:nselect]
resids <- resids[select,]

ord <- order(coldata$treatment, as.numeric(coldata$time), coldata$batchA)
resids <- resids[,ord]
df <- coldata[ord,] %>% dplyr::select(-c(batch, batchA))
rownames(df) <- colnames(resids)

rownames(resids) <- paste(1:nselect, '. ', rownames(resids), sep = "")

pheatmap(resids, cluster_rows=FALSE, show_rownames=TRUE, show_colnames = FALSE,
         cluster_cols=FALSE, annotation_col=df)
```


```{r de-over-time}
# 75 v DMSO @ 48
de.time <- data.frame(
  fc45.D.48 = results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  1 # 45 and 48 hrs
))$log2FoldChange
)

# 30 v DMSO @ 48
de.time$fc30.D.48 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  1, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 45 v DMSO @ 24
de.time$fc45.D.24 <- results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  1, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 30 v DMSO @ 24
de.time$fc30.D.24 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  1, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 45 v DMSO @ 8
de.time$fc45.D.8 <- results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  1, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 30 v DMSO @ 8
de.time$fc30.D.8 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  1, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 45 v DMSO @ 1
de.time$fc45.D.1 <- results(dds, contrast = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

# 30 v DMSO @ 1
de.time$fc30.D.1 <- results(dds, contrast = c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
))$log2FoldChange

rownames(de.time) <- rownames(results(dds))
de.time <- de.time[complete.cases(de.time),]

gene_ord_all <- list(
  "p" = rownames(results(dds)[order(res$padj, decreasing = F),]),
  "up" = rownames(results(dds)[order(res$log2FoldChange, decreasing = T),]),
  "down" = rownames(results(dds)[order(res$log2FoldChange, decreasing = F),]),
  'any' = rownames(results(dds)[order(abs(res$log2FoldChange), decreasing = T),])
)
gene_ord <- sapply(gene_ord_all, function(x) {
  x <- x[!is.na(results(dds)[x,"padj"]) & (results(dds)[x,"padj"] < 0.05)]
}, USE.NAMES = T, simplify = F)
gene_ord[['p']] <- gene_ord_all[['p']]

de.time <- de.time[complete.cases(de.time),]

de.time <- 
  de.time %>%
  tibble::rownames_to_column(var = "Gene") %>%
  tidyr::pivot_longer(cols = 2:9) %>%
  mutate(treatment = as.numeric(substr(name, 3, 4))) %>%
  mutate(time = as.numeric(substr(name, 8, 9))) %>%
  dplyr::select(-name) %>%
  dplyr::rename(log2FoldChange = value) %>%
  mutate(p.adj = res[Gene,"padj"])
```

# Gene Set Exploration

```{r, cache=F}
source("plot-heatmap.R")
source("expression-barplot.R" )
```

```{r}
genesets <- list(
  "Oxidative Stress" = list(
    "Redox" = c(
      "SLC7A11", 
      "CHAC1", 
      "MTHFD2", 
      "SOD2",
      "SESN2",
      "GDF15",
      "GADD45A",
      "TXNIP"
    ),
    "DNA Repair" = c(
      "UNC5B",
      "DDIT4",
      "RBBP8",
      "LONP1"
    )
  ),
  "Cell Cycle" = list(
    "Mitotic Checkpoint" = c(
      "BUB1", "BUB1B", "BUB3"
    ),
    "DNA Replication Initiation" = c(
      "MCM10", "MCM4"
    )
  ),
  "RNA and Protein Processing" = list(
    "Spliceosome" = c(
      "DDX23",
      "DDX24",
      "DDX3X"
    ),
    "Proteasome" = c(
      "PSMC2",
      "PSMD1",
      "PSMD12", 
      "PSMD6",
      "PSMB2"
    ),
    "Ribonucleoprotein Complex" = c(
      "SNRPD3",
      "SNRPD1",
      "SNRPB2",
      "HNRNPH2",
      "HNRNPM",
      "HNRNPF",
      "HNRNPDL",
      "HNRNPR",
      "HNRNPU",
      "HNRNPD",
      "HNRNPA1"
    ),
    "Serine and Arginine-rich Splicing Factors" = c(
      "SRSF3",
      "SRSF2",
      "SRSF11",
      "SRSF10",
      "SRSF1"
    )
  ),
  "Glycolysis and Pentose Phosphate Pathway" = list(
    "Glycolysis and Pentose Phosphate Pathway" = c(
      "GPI",
      "ALDOA",
      "G6PD",
      "PGLS"
    )
  ),
  "Folate Cycle" = list(
    "Folate Cycle" = c("ALDH1L2", "MTHFD2", "MTHFD1L", "SHMT2", "DHFR")
  ),
  "Glutathione Synthesis" = list(
    "Glutathione Synthesis" = c(
      "GCLC",
      "GCLM",
      "CTH",
      "CBS",
      "SLC7A11"
    )
  ),
  "Protein Processing in ER - 1" = list(
    "ER Chaperones" = c(
      "CALR",
      "HSPA1L",
      'HSPA8',
      'DNAJA1',
      'HSP90AA1',
      'HSP90AB1',
      'HSP90B1',
      'HSPH1'
    ),
    "Protein Processing Machinery" = c(
      "SEC61B",
      'STT3B',
      'OSTC'
    ),
    "Protein Quality Control" = c(
      "DAD1",
      'UBQLN1',
      'UBQLN2',
      'SKP1',
      'CUL1',
      'TRAM1L1'
    )
  ),
  "Protein Processing in ER - 2" = list(
    'ER-associated Protein Degradation' = c(
      'GANAB',
      'RAD23A',
      'SEL1L',
      'SEL1L3',
      'HERPUD1',
      'SYVN1'
    ),
    "ER Quality Control" = c(
      'UGGT2',
      'DNAJC10',
      'DNAJC1',
      'MOGS'
    ),
    "Unfolded Protein Response" = c(
      'ATF4',
      'ATF6',
      'ERN1',
      'XBP1',
      'DDIT3'
    )
  ),
  'CHOP-regulated Genes' = list(
    'CHOP-regulated Genes' = c(
      'TRIB3',
      'TNFRSF10B',
      'PPP1R15A',
      'KLHDC7B',
      'BBC3',
      'PMAIP1',
      'HRK'
    )
  ),
  'Natural Killer Cell Ligands' = list(
    'Natural Killer Cell Ligands' = c(
      'MICB',
      'ULBP1',
      'ULBP2',
      'NCR3LG1'
    )
  ),
  "Immune-related Genes" = list(
    "Chemokines" = c(
      'CXCL8',
      'CXCL16',
      'CXCL10'
    ),
    "Death Receptors" = c(
      'TNFRSF10A',
      'TNFRSF10B'
    )
  )
)
```

## Oxidative Stress

This super category is defined by the sub-categories as

```{r}
genesets[["Oxidative Stress"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Oxidative Stress"]], width = 8000, height = 8000)
```

And then a barplot.


```{r}
expression_barplot(
  de.time, 
  genesets[["Oxidative Stress"]], 
  x_offset = 0.8,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-4, 4)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```

```{r, fig.height=12, fig.width=12}
expression_barplot(
  de.time, 
  genesets[["Oxidative Stress"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-4, 4)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```





## Cell Cycle

This super category is defined by the sub-categories as

```{r}
genesets[["Cell Cycle"]]  
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Cell Cycle"]]) 
```

And then a barplot.


```{r}
text_size=19
expression_barplot(
  de.time, 
  genesets[["Cell Cycle"]], 
  x_offset = 0.0,
  time_color_palette = "Viridis", 
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-2.05, 0.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
# expression_barplot(de.time, genesets[["Cell Cycle"]]) +
  # scale_x_continuous(limits = c(-2.05, 0.5))
```

```{r}
text_size=19
expression_barplot(
  de.time, 
  genesets[["Cell Cycle"]], 
  x_offset = 2.7, 
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-2.05, 0.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
# expression_barplot(de.time, genesets[["Cell Cycle"]]) +
  # scale_x_continuous(limits = c(-2.05, 0.5))
```


## RNA and Protein Processing

This super category is defined by the sub-categories as

```{r}
genesets[["RNA and Protein Processing"]]
```

TODO: DDX3X3 was not in the gene list. I replaced it with DDX3X.

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["RNA and Protein Processing"]])
```

And then a barplot.



```{r, fig.height=20, fig.width=20}
text_size=25
expression_barplot(
  de.time, 
  genesets[["RNA and Protein Processing"]], 
  x_offset = 1,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8,
  var_width = 20
) +
  scale_x_continuous(limits = c(-2.05, 0.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )  
  
```

```{r, fig.height=20, fig.width=20}
text_size=25
expression_barplot(
  de.time, 
  genesets[["RNA and Protein Processing"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8,
  var_width = 25
) +
  scale_x_continuous(limits = c(-2.05, 0.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )  
  
```



## Oxidative Stress

This super category is defined by the genes

```{r}
genesets[["Glycolysis and Pentose Phosphate Pathway"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Glycolysis and Pentose Phosphate Pathway"]])
```

And then a barplot.



```{r}
text_size = 20
expression_barplot( 
  de.time, 
  genesets[["Glycolysis and Pentose Phosphate Pathway"]], 
  x_offset = 0.2,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-1, 1)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  ) 
```

```{r}
expression_barplot( 
  de.time, 
  genesets[["Glycolysis and Pentose Phosphate Pathway"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-1, 1)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  ) 
```




## Folate Cycle

This super category is defined by the sub-categories as

```{r}
genesets[["Folate Cycle"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Folate Cycle"]])
```

And then a barplot.


```{r}
expression_barplot(
  de.time, 
  genesets[["Folate Cycle"]], 
  x_offset = 1,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-2.5, 2.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  ) 
```

```{r}
expression_barplot(
  de.time, 
  genesets[["Folate Cycle"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-2.5, 2.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  ) 
```



## Glutathione Synthesis

This super category is defined by the sub-categories as

```{r}
genesets[["Glutathione Synthesis"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Glutathione Synthesis"]])
```

And then a barplot.

```{r}
expression_barplot(
  de.time, 
  genesets[["Glutathione Synthesis"]], 
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-2.5, 2.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```

```{r}
expression_barplot(
  de.time, 
  genesets[["Glutathione Synthesis"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-2.5, 2.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```



## Protein Processing in ER - 1

This super category is defined by the sub-categories as

```{r}
genesets[["Protein Processing in ER - 1"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Protein Processing in ER - 1"]])
```

And then a barplot.


```{r}
text_size = 20
expression_barplot(
  de.time, 
  genesets[["Protein Processing in ER - 1"]], 
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8,
  var_width = 10
) +
  scale_x_continuous(limits = c(-3.5, 3.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```


```{r}
expression_barplot(
  de.time, 
  genesets[["Protein Processing in ER - 1"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8,
  var_width = 10
) +
  scale_x_continuous(limits = c(-3.5, 3.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```



## Protein Processing in ER - 2

This super category is defined by the sub-categories as

```{r}
genesets[["Protein Processing in ER - 2"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Protein Processing in ER - 2"]])
```

And then a barplot.


```{r}
expression_barplot(
  de.time, 
  genesets[["Protein Processing in ER - 2"]], 
  x_offset = 2,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8,
  var_width = 10
) +
  scale_x_continuous(limits = c(-3.5, 3.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```

```{r}
expression_barplot(
  de.time, 
  genesets[["Protein Processing in ER - 2"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8,
  var_width = 10
) +
  scale_x_continuous(limits = c(-3.5, 3.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```



## CHOP-regulated Genes

This super category is defined by the sub-categories as

```{r}
genesets[["CHOP-regulated Genes"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["CHOP-regulated Genes"]])
```

And then a barplot.


```{r}
expression_barplot(
  de.time, 
  genesets[["CHOP-regulated Genes"]], 
  x_offset = 4,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-6, 6)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```

```{r}
expression_barplot(
  de.time, 
  genesets[["CHOP-regulated Genes"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-6, 6)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```



## Natural Killer Cell Ligands

This super category is defined by the sub-categories as

```{r}
genesets[["Natural Killer Cell Ligands"]] 
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Natural Killer Cell Ligands"]]) 
```

And then a barplot.


```{r}
expression_barplot( 
  de.time, 
  genesets[["Natural Killer Cell Ligands"]], 
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-3, 3)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```


```{r}
expression_barplot( 
  de.time, 
  genesets[["Natural Killer Cell Ligands"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-3, 3)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```



## Immune-related Genes

This super category is defined by the sub-categories as

```{r}
genesets[["Immune-related Genes"]]
```

First we plot a heatmap.

```{r}
expression_heatmap(de.time, genesets[["Immune-related Genes"]])
```

And then a barplot.



```{r}
expression_barplot(
  de.time, 
  genesets[["Immune-related Genes"]], 
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8
) +
  scale_x_continuous(limits = c(-3, 3)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```

```{r}
expression_barplot(
  de.time, 
  genesets[["Immune-related Genes"]], 
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8
) +
  scale_x_continuous(limits = c(-3, 3)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
```





# pathfindR


```{r, fig.height=8, fig.width=16}
text_size = 23
kegg.df <- read.csv("pathfindR-active-sets.csv")
kegg_sets <- c(
              "Proteasome", 
              "Spliceosome",
              "Ribosome",
              "Cell cycle",
              "Oxidative phosphorylation",
              "Glycolysis / Gluconeogenesis",
              "Citrate cycle (TCA cycle)",
              "Pentose phosphate pathway",
              "Glutathione metabolism",
              "One carbon pool by folate",
              "Protein processing in endoplasmic reticulum",
              "Apoptosis",
              "Natural killer cell mediated cytotoxicity",
              "Cytokine-cytokine receptor interaction",
              "Chemokine signaling pathway"
            )

rearrange_clust <- Vectorize(function(x) {
  if ( x == 5 ) return(1)
  if ( x < 5 ) return(x+1)
  if (x > 5) return(x)
  
})
kegg.df <- kegg.df %>% filter(Term_Description %in% kegg_sets)
kegg.df <- cluster_enriched_terms(kegg.df, plot_clusters_graph = F)
kegg.df <- kegg.df %>%
  mutate(Cluster = rearrange_clust(Cluster))
                                   kegg.df
enrichment_chart(
  kegg.df,
  top_terms = length(kegg_sets),
  plot_by_cluster = T
) + 
  scale_color_gradient(low = "#f59f9f", high = "red") +
  theme(
    strip.text.y = element_text(face="bold", size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    legend.text = element_text(size=text_size),
    legend.title = element_text(size=text_size),
    axis.text.x = element_text(size = text_size),
    axis.title.x = element_text(size=text_size, face="bold")
  )


```

```{r, fig.height=8, fig.width=16}
text_size = 20
clu <- cluster_enriched_terms(kegg.df, use_description = T, method="hierarchical", plot_clusters_graph=F)
term_gene_heatmap(clu %>% arrange(Cluster), use_description = T, num_terms = nrow(kegg.df), legend_title = "Change") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(face = "bold", size=text_size),
    legend.text = element_text(size=text_size),
    legend.title = element_text(size=text_size)
  ) +
  ggtitle("") + 
  labs(fill = "Change") + 
  scale_fill_manual(values = c("red", "green"), labels = c("Down", "Up", "No Change"), na.value="white") 
```

```{r}
text_size = 50
lout = "circlepack"
p0 <- term_gene_graph(kegg.df, use_description = T, num_terms=nrow(kegg.df))
g <- tidygraph::to_directed(attributes(p0$data)$graph)

ggVennDiagram::ggVennDiagram(setNames(lapply(1:nrow(kegg.df), function(x) {
  igraph::vertex_attr(g, "name", igraph::neighbors(g, igraph::V(g)[x]))
}), igraph::vertex_attr(g, "name", igraph::V(g)[1:nrow(kegg.df)])), nintersects = 30, 
  label_size = text_size,
  label_txtWidth = text_size,
  set_size = text_size,
  set_color = "green"
)
```


```{r}
kegg.df <- cluster_enriched_terms(kegg.df, plot_clusters_graph = F, use_description = T, method="hierarchical")
kappa_mat <- create_kappa_matrix(kegg.df, use_description = T)

stats::heatmap(kappa_mat, 
               distfun = function(x) { stats::as.dist(1 - x)}, 
               hclustfun = function(x) stats::hclust(x, method = "average"), 
               margins = c(10,5)
               )
```


```{r, include=F}

input_processed <- input_processing(
  res %>%
    mutate(gene = rownames(.)) %>%
    dplyr::select(gene, log2FoldChange, padj) %>%
    mutate(padj = ifelse(is.na(padj), 1, padj))
)
# path.out <- run_pathfindR(
#   res %>%
#     mutate(gene = rownames(.)) %>%
#     dplyr::select(gene, log2FoldChange, padj) %>%
#     mutate(padj = ifelse(is.na(padj), 1, padj))
# )
gg_list <- visualize_terms(kegg.df[10:11,], input_processed, is_KEGG_result = T)

kegg.df
```

```{r}
gg_list[[1]] + 
  scale_fill_gradient2(low = "red", mid = "gray", high = "green", lim = c(-1, 1))
```




```{r}
gg_list[[2]] + scale_fill_gradient2(low = "red", mid = "gray", high = "green", lim = c(-1, 1))
```

```{r, evaluate=F, include=F}
for (g in names(gg_list)) {
  ggplot2::ggsave(
    paste("results/pathfindR-vis/", g, ".pdf", sep = ""),
    gg_list[[g]]+ scale_fill_gradient2(low = "red", mid = "gray", high = "green", lim = c(-1, 1))
  )
}
```


## Number DE vs time


The plot below shows the number of DE genes (when compared to DMSO at the same time) over time. 
Note that, since we aren't much interested in the 1 hour time point, we keep a Bonferroni adjustment multiplier of 6, and we simply avoid inference on the 1 hour time point. 

We see that the number of DE genes does seem to increase over time, with the higher dose of atovaquone having typically more DE genes than the lower.
However, after 24 hours in the 45 uM group, the rate of new DE genes drops off, gaining only 371 genes by 48 hours, while the 30 uM group gained 1671 new DE genes in the same time. 

This image can be found in `figures/DE-counts.png`.

```{r contrast-prep}
# 75 v DMSO @ 48
contrasts <- list(
  h48.45vsD = c(
    0, # Intercept
    0, # 30 vs D
    1, # 45 vs D
    0, # 8 hrs vs 1 hr
    0, # 24 hrs vs 1 hr
    0, # 48 hrs vs 1 hr
    0, # batch A
    0, # 30 and 8 hrs
    0, # 45 and 8 hrs
    0, # 30 and 24 hrs
    0, # 45 and 24 hrs
    0, # 30 and 48 hrs
    1 # 45 and 48 hrs
  )
)

# 30 v DMSO @ 48
contrasts$h48.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  1, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 45 v DMSO @ 24
contrasts$h24.45vsD = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  1, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 30 v DMSO @ 24
contrasts$h24.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  0, # 45 and 8 hrs
  1, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 45 v DMSO @ 8
contrasts$h8.45vsD = c(
  0, # Intercept
  0, # 30 vs D
  1, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  0, # 30 and 8 hrs
  1, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

# 30 v DMSO @ 8
contrasts$h8.30vsD <- c(
  0, # Intercept
  1, # 30 vs D
  0, # 45 vs D
  0, # 8 hrs vs 1 hr
  0, # 24 hrs vs 1 hr
  0, # 48 hrs vs 1 hr
  0, # batch A
  1, # 30 and 8 hrs
  0, # 45 and 8 hrs
  0, # 30 and 24 hrs
  0, # 45 and 24 hrs
  0, # 30 and 48 hrs
  0 # 45 and 48 hrs
)

contrasts_all <- contrasts
# 45 v DMSO @ 1
# contrasts_all$h1.45vsD = c(
#   0, # Intercept
#   0, # 30 vs D
#   1, # 45 vs D
#   0, # 8 hrs vs 1 hr
#   0, # 24 hrs vs 1 hr
#   0, # 48 hrs vs 1 hr
#   0, # batch A
#   0, # 30 and 8 hrs
#   0, # 45 and 8 hrs
#   0, # 30 and 24 hrs
#   0, # 45 and 24 hrs
#   0, # 30 and 48 hrs
#   0 # 45 and 48 hrs
# )
# 
# # 30 v DMSO @ 1
# contrasts_all$h1.30vsD <- c(
#   0, # Intercept
#   1, # 30 vs D
#   0, # 45 vs D
#   0, # 8 hrs vs 1 hr
#   0, # 24 hrs vs 1 hr
#   0, # 48 hrs vs 1 hr
#   0, # batch A
#   0, # 30 and 8 hrs
#   0, # 45 and 8 hrs
#   0, # 30 and 24 hrs
#   0, # 45 and 24 hrs
#   0, # 30 and 48 hrs
#   0 # 45 and 48 hrs
# )
```

```{r de-vs-time, warning=F, message=F}
p <- lapply(contrasts_all, function(x) {
  results(dds, test = "Wald", contrast = x) %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene") %>%
    mutate(sig = as.numeric(!is.na(padj) & padj < alpha / 6))
}) %>%
  bind_rows(.id = "comparison") %>%
  dplyr::select(comparison, gene, sig) %>%
  mutate(time = substr(comparison, 2, 3)) %>%
  mutate(time = ifelse(
    substr(time, 3, 3) == '.', 
    substr(time, 2, 2),
    as.numeric(time)
  )) %>%
  mutate(Treatment = paste(
    ifelse(
      substr(comparison, 3, 3) == '.', 
      substr(comparison, 4, 5), 
      substr(comparison, 5, 6)
    ),
    "uM", sep = " "
  )) %>%
  group_by(time, Treatment) %>%
  summarize(genes = sum(sig)) %>%
  mutate(time = as.factor(time)) %>%
  #filter(sig == 1) %>%
  #ggplot(aes(x = time, y = log2(1+genes), fill = Treatment)) +
  ggplot(aes(x = time, y = genes, fill = Treatment)) +
    geom_col(position = position_dodge2(width=0.5)) +
    xlab("Time (Hours)") +
    ylab(expression(log2(1 + count))) +
    theme_classic() + 
    scale_fill_manual(values = c(
      '#91188E',
      '#539027'))

#png(filename = "figures/DE-counts.png")
# p
#dev.off()


p
```

This upset plot helps further elucidate the intersection pattern of these genes. This plot can be found in `figures/DE-upset.png`.

```{r upset-de-genes, fig.height = 6}
to_plot <- 
  lapply(contrasts_all, function(x) {
  results(dds, test = "Wald", contrast = x) %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene") %>%
    mutate(sig = as.numeric(!is.na(padj) & padj < alpha / 6))
})%>%
  bind_rows(.id = "comparison") %>%
  dplyr::select(comparison, gene, sig) %>%
  filter(sig == 1) %>%
  mutate(time = substr(comparison, 2, 3)) %>%
  mutate(time = ifelse(
    substr(time, 3, 3) == '.', 
    substr(time, 2, 2),
    as.numeric(time)
  )) %>%
  mutate(treatment =
    paste(ifelse(
      substr(comparison, 3, 3) == '.', 
      substr(comparison, 4, 5), 
      substr(comparison, 5, 6)
    ), " Î¼M",
    sep = ""
  )) %>%
  mutate(time = paste(time, " hours", sep = "")) %>%
  mutate(group = paste(treatment, " @ ", time, sep = "")) %>%
  group_by(gene) %>%
  summarize(group = list(group))
text_size = 20
to_plot %>%
  ggplot(aes(x = group)) +
    geom_bar() + 
    ggupset::scale_x_upset() +
    theme_classic() +  
    theme(
      axis.title.y = element_text(margin = margin(80, 80, 5, 0), size = text_size),
      axis.text.y = element_text(size=text_size, margin = margin(l=20, b=10)),
      axis.title.x = element_text(size = text_size),
      axis.text.x = element_text(size = text_size)
    ) +
    xlab("Set Intersection") + 
    ylab("Intersection Size")
```


## Protein Processing in ER + CHOP


```{r, fig.height=40, fig.width = 20}
require(gridExtra)
text_size = 30
pER <- expression_barplot(
  de.time, 
  c(
    genesets[["Protein Processing in ER - 1"]], 
    genesets[["Protein Processing in ER - 2"]]
  ),
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8,
  var_width = 10
) +
  scale_x_continuous(limits = c(-3.5, 3.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )

pChop <- expression_barplot(
  de.time, 
  genesets[["CHOP-regulated Genes"]], 
  x_offset = 4,
  time_color_palette = "Viridis",
  pval_annotation = T,
  width = 0.8,
  var_width = 20
) +
  scale_x_continuous(limits = c(-6, 6)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
grid.arrange(pER, pChop, heights = c(32, 7))
```




```{r, fig.height=40, fig.width = 20}
require(gridExtra)
text_size = 30
pER <- expression_barplot(
  de.time, 
  c(
    genesets[["Protein Processing in ER - 1"]], 
    genesets[["Protein Processing in ER - 2"]]
  ),
  x_offset = 1.5,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8,
  var_width = 10
) +
  scale_x_continuous(limits = c(-3.5, 3.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )

pChop <- expression_barplot(
  de.time, 
  genesets[["CHOP-regulated Genes"]], 
  x_offset = 4,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8,
  var_width = 20
) +
  scale_x_continuous(limits = c(-6, 6)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )
grid.arrange(pER, pChop, heights = c(32, 7))
```


```{r, fig.height=30, fig.width=30}
text_size=25
pBar <- expression_barplot(
  de.time, 
  genesets[["RNA and Protein Processing"]], 
  x_offset = 2.7,
  time_color_palette = "Viridis",
  pval_annotation = F,
  width = 0.8,
  var_width = 25
) +
  scale_x_continuous(limits = c(-2.05, 0.5)) +
  ggtitle("") + 
  theme_bw() + 
  theme(
    axis.line = element_line(color = 'black'),
    panel.grid.major = element_blank(),
    strip.text.y = element_text(face = "bold", size=text_size),
    strip.text.x = element_text(size = text_size),
    axis.text.x = element_text(size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    axis.title.y = element_text(size=text_size),
    axis.title.x = element_text(size=text_size),
    legend.text = element_text(size = text_size),
    legend.title = element_text(size = text_size)#,
    #panel.grid.minor = element_blank()
  )  
pBub <- enrichment_chart(
  kegg.df,
  top_terms = length(kegg_sets),
  plot_by_cluster = T
) + 
  scale_color_gradient(low = "#f59f9f", high = "red") +
  theme(
    strip.text.y = element_text(face="bold", size=text_size),
    axis.text.y = element_text(face = "bold", size=text_size),
    legend.text = element_text(size=text_size),
    legend.title = element_text(size=text_size),
    axis.text.x = element_text(size = text_size),
    axis.title.x = element_text(size=text_size, face="bold")
  )
grid.arrange(pBar, pBub, heights = c(10, 5), widths = c(1, 1.5))
```





